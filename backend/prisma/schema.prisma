// Schema Prisma - Marketplace Multi-Loja (marcket)
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Lojas {
  id                    String    @id @default(cuid())
  nome                  String
  slug                  String    @unique
  categoria_negocio     String
  cidade                String
  endereco              String    @default("")
  telefone              String    @default("")
  horario_funcionamento String    @default("")
  horario_abertura      String    @default("")
  horario_fechamento    String    @default("")
  logo_url              String
  banner_url            String    @default("")
  cor_primaria          String
  ativa                 Boolean
  aberta                Boolean
  forcar_status         Boolean   @default(false)
  taxa_entrega          Float     @default(0)
  tempo_entrega         String    @default("")
  modo_atendimento      String    @default("AMBOS")
  pix_tipo              String    @default("")
  pix_chave             String    @default("")
  pix_nome_titular      String    @default("")
  pix_cidade            String    @default("")
  formas_pagamento      String    @default("PIX,CREDIT,DEBIT,CASH")
  horarios_semana       String    @default("[]")
  pedido_minimo         Decimal   @default(0)
  vencimento            DateTime  @default(now())

  produtos    Produtos[]
  avaliacoes  Avaliacao[]
  usuarios    Usuarios[]
  pedidos     Pedidos[]
  bairroTaxas BairroTaxa[]
  impressoras Impressora[]
  cupons          Cupom[]
  motoboys        Motoboy[]
  filaImpressao   FilaImpressao[]
  combos          Combo[]
  mensagens       Mensagem[]
  cobrancas       CobrancaLojista[]
  promocoes       Promocao[]
  stories         LojaStory[]
  token_impressao          String    @default("")
  categorias_desativadas   String    @default("[]")

  @@index([ativa, cidade])
  @@index([categoria_negocio])
}

model LojaStory {
  id           String   @id @default(cuid())
  restaurant_id String
  image_url    String
  media_type   String   @default("image")
  link_url     String?
  coupon_code  String?
  is_sponsored Boolean  @default(false)
  created_at   DateTime @default(now())
  expires_at   DateTime
  is_active    Boolean  @default(true)

  restaurant Lojas @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)

  @@index([restaurant_id, is_active, expires_at], map: "idx_restaurant_stories_active")
  @@map("restaurant_stories")
}

model Usuarios {
  id           String   @id @default(cuid())
  loja_id      String
  nome         String
  email        String
  firebase_uid String   @unique
  role         Role

  loja      Lojas          @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  fcmTokens FcmTokenLoja[]

  @@index([loja_id])
}

model FcmTokenLoja {
  id         String   @id @default(cuid())
  usuario_id String
  token      String   @unique
  created_at DateTime @default(now())

  usuario Usuarios @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
}

enum Role {
  ADMIN
  EMPLOYEE
}

model Produtos {
  id               String   @id @default(cuid())
  loja_id          String
  nome             String
  descricao        String
  preco            Decimal
  estoque          Int
  imagem_url       String
  categoria        String   @default("")
  setor_impressao  String   @default("")
  ativo            Boolean
  destaque         Boolean  @default(false)

  loja       Lojas              @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  itens      ItensPedido[]
  variacoes  VariacaoProduto[]
  adicionais AdicionalProduto[]
  comboItens ComboItem[]
  promocoes  Promocao[]

  @@index([loja_id, ativo])
  @@index([loja_id, destaque, ativo])
  @@index([loja_id, categoria])
}

model VariacaoProduto {
  id         String  @id @default(cuid())
  produto_id String
  nome       String
  preco      Decimal

  produto Produtos @relation(fields: [produto_id], references: [id], onDelete: Cascade)

  @@index([produto_id])
}

model AdicionalProduto {
  id         String  @id @default(cuid())
  produto_id String
  nome       String
  preco      Decimal

  produto Produtos @relation(fields: [produto_id], references: [id], onDelete: Cascade)

  @@index([produto_id])
}

model Clientes {
  id           String   @id @default(cuid())
  firebase_uid String   @unique
  nome         String
  email        String
  telefone     String   @default("")
  created_at   DateTime @default(now())

  enderecos  EnderecoCliente[]
  pedidos    Pedidos[]
  fcmTokens  FcmToken[]
  cupomUsos  CupomUso[]
  avaliacoes Avaliacao[]
}

model FcmToken {
  id         String   @id @default(cuid())
  cliente_id String
  token      String   @unique
  created_at DateTime @default(now())

  cliente Clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)

  @@index([cliente_id])
}

model EnderecoCliente {
  id         String  @id @default(cuid())
  cliente_id String
  apelido    String  @default("")
  cidade     String  @default("")
  bairro     String
  rua        String
  numero     String
  complemento String @default("")
  referencia String  @default("")
  padrao     Boolean @default(false)

  cliente Clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)

  @@index([cliente_id])
}

model Cidades {
  id       String @id @default(cuid())
  id_ibge  Int    @unique
  nome     String
  estado   String

  @@unique([estado, nome])
  @@index([estado, nome])
}

model Pedidos {
  id               String         @id @default(cuid())
  loja_id          String
  cliente_id       String?
  cupom_id         String?
  nome_cliente     String
  telefone_cliente String
  endereco         String
  bairro           String         @default("")
  complemento      String         @default("")
  referencia       String         @default("")
  taxa_entrega     Decimal        @default(0)
  subtotal         Decimal        @default(0)
  desconto         Decimal        @default(0)
  total            Decimal
  tipo_entrega     TipoEntrega    @default(ENTREGA)
  status           StatusPedido
  forma_pagamento  FormaPagamento
  observacao       String         @default("")
  agendado_para    DateTime?
  created_at       DateTime       @default(now())

  loja      Lojas         @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  cliente   Clientes?     @relation(fields: [cliente_id], references: [id])
  cupom     Cupom?        @relation(fields: [cupom_id], references: [id])
  itens     ItensPedido[]
  cupomUsos CupomUso[]
  avaliacao Avaliacao?
  mensagens Mensagem[]

  @@index([loja_id, status])
  @@index([loja_id, created_at])
  @@index([cliente_id])
}

model Avaliacao {
  id         String   @id @default(cuid())
  loja_id    String
  cliente_id String
  pedido_id  String   @unique
  nota       Int
  comentario String   @default("")
  created_at DateTime @default(now())

  loja    Lojas    @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  cliente Clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  pedido  Pedidos  @relation(fields: [pedido_id], references: [id], onDelete: Cascade)

  @@index([loja_id, created_at])
  @@index([cliente_id])
}

model ItensPedido {
  id              String  @id @default(cuid())
  pedido_id       String
  produto_id      String
  quantidade      Int
  preco_unitario  Decimal
  variacao_nome   String  @default("")
  variacao_preco  Decimal @default(0)
  adicionais_json String  @default("[]")

  pedido  Pedidos  @relation(fields: [pedido_id], references: [id], onDelete: Cascade)
  produto Produtos @relation(fields: [produto_id], references: [id], onDelete: Cascade)

  @@index([pedido_id])
  @@index([produto_id])
}

model BairroTaxa {
  id      String  @id @default(cuid())
  loja_id String
  nome    String
  taxa    Decimal

  loja Lojas @relation(fields: [loja_id], references: [id], onDelete: Cascade)

  @@unique([loja_id, nome])
}

model Impressora {
  id      String  @id @default(cuid())
  loja_id String
  setor   String
  nome    String  @default("")
  ip      String
  porta   Int     @default(9100)
  largura Int     @default(80)
  ativa   Boolean @default(true)

  loja Lojas @relation(fields: [loja_id], references: [id], onDelete: Cascade)

  @@unique([loja_id, setor])
}

model Cupom {
  id                String      @id @default(cuid())
  loja_id           String
  codigo            String
  tipo_desconto     TipoDesconto
  valor_desconto    Decimal
  valor_minimo      Decimal?
  max_usos          Int?
  usos_count        Int         @default(0)
  usos_por_cliente  Int?
  data_inicio       DateTime
  data_fim          DateTime
  ativo             Boolean     @default(true)
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  loja      Lojas       @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  pedidos   Pedidos[]
  usos      CupomUso[]

  @@unique([loja_id, codigo])
}

model CupomUso {
  id         String   @id @default(cuid())
  cupom_id   String
  cliente_id String
  pedido_id  String
  usado_em   DateTime @default(now())

  cupom   Cupom    @relation(fields: [cupom_id], references: [id], onDelete: Cascade)
  cliente Clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  pedido  Pedidos  @relation(fields: [pedido_id], references: [id], onDelete: Cascade)

  @@index([cupom_id, cliente_id])
}

model Motoboy {
  id         String   @id @default(cuid())
  loja_id    String
  nome       String
  email      String
  senha_hash String
  ativo      Boolean  @default(true)
  created_at DateTime @default(now())

  loja           Lojas           @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  passwordResets PasswordReset[]

  @@unique([loja_id, email])
  @@index([loja_id])
}

model FilaImpressao {
  id           String              @id @default(cuid())
  loja_id      String
  pedido_id    String
  setor        String
  impressora_ip    String
  impressora_porta Int             @default(9100)
  largura      Int                 @default(80)
  conteudo     String
  status       StatusImpressao     @default(PENDING)
  tentativas   Int                 @default(0)
  erro         String              @default("")
  created_at   DateTime            @default(now())
  printed_at   DateTime?

  loja Lojas @relation(fields: [loja_id], references: [id], onDelete: Cascade)

  @@index([loja_id, status])
  @@index([created_at])
}

model PasswordReset {
  id         String   @id @default(cuid())
  motoboy_id String
  token      String   @unique
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  motoboy Motoboy @relation(fields: [motoboy_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([motoboy_id])
}

model Combo {
  id          String   @id @default(cuid())
  loja_id     String
  nome        String
  descricao   String   @default("")
  preco       Decimal
  imagem_url  String   @default("")
  ativo       Boolean  @default(true)
  created_at  DateTime @default(now())

  loja  Lojas       @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  itens ComboItem[]

  @@index([loja_id, ativo])
}

model ComboItem {
  id         String @id @default(cuid())
  combo_id   String
  produto_id String
  quantidade Int    @default(1)

  combo   Combo    @relation(fields: [combo_id], references: [id], onDelete: Cascade)
  produto Produtos @relation(fields: [produto_id], references: [id], onDelete: Cascade)

  @@index([combo_id])
}

model Mensagem {
  id         String          @id @default(cuid())
  pedido_id  String
  loja_id    String
  remetente  RemetenteMensagem
  conteudo   String
  arquivo_url  String        @default("")
  arquivo_nome String        @default("")
  arquivo_mime String        @default("")
  lido       Boolean         @default(false)
  created_at DateTime        @default(now())

  pedido Pedidos @relation(fields: [pedido_id], references: [id], onDelete: Cascade)
  loja   Lojas   @relation(fields: [loja_id], references: [id], onDelete: Cascade)

  @@index([pedido_id, created_at])
  @@index([loja_id, lido])
}

model CobrancaLojista {
  id                String         @id @default(cuid())
  loja_id           String
  competencia       String
  periodo_inicio    DateTime
  periodo_fim       DateTime
  percentual        Decimal        @default(0)
  faturamento_bruto Decimal        @default(0)
  pedidos_count     Int            @default(0)
  valor_comissao    Decimal        @default(0)
  status            StatusCobranca @default(ABERTA)
  fechado_em        DateTime?
  vencimento_em     DateTime?
  pago_em           DateTime?
  observacao        String         @default("")
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt

  loja  Lojas            @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  itens CobrancaPedido[]

  @@unique([loja_id, competencia])
  @@index([competencia, status])
}

model CobrancaPedido {
  id           String   @id @default(cuid())
  cobranca_id  String
  pedido_id    String
  loja_id      String
  total        Decimal
  status_pedido String  @default("")
  pedido_criado_em DateTime
  created_at    DateTime @default(now())

  cobranca CobrancaLojista @relation(fields: [cobranca_id], references: [id], onDelete: Cascade)

  @@unique([cobranca_id, pedido_id])
  @@index([loja_id, pedido_criado_em])
}

model Promocao {
  id               String   @id @default(cuid())
  loja_id          String
  produto_id       String?
  titulo           String
  descricao        String   @default("")
  imagem_url       String   @default("")
  preco_promocional Decimal @default(0)
  ativo            Boolean  @default(true)
  destaque_inicio  DateTime?
  destaque_fim     DateTime?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  loja    Lojas    @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  produto Produtos? @relation(fields: [produto_id], references: [id], onDelete: SetNull)

  @@index([loja_id, ativo])
  @@index([produto_id])
}

enum RemetenteMensagem {
  CLIENTE
  LOJA
}

enum StatusImpressao {
  PENDING
  PRINTED
  ERROR
}

enum TipoDesconto {
  PERCENTAGE
  FIXED
}

enum StatusPedido {
  PENDING
  APPROVED
  IN_ROUTE
  DELIVERED
  CANCELLED
}

enum FormaPagamento {
  PIX
  DEBIT
  CREDIT
  CASH
}

enum TipoEntrega {
  ENTREGA
  RETIRADA
}

enum StatusCobranca {
  ABERTA
  FECHADA
  PAGA
}
